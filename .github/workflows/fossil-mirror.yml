name: Mirror from Fossil

on:
  schedule:
    # 毎時0分に実行（UTC）
    - cron: '0 * * * *'
  
  # 手動実行も可能
  workflow_dispatch:

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitHub repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Fossil
        run: |
          sudo apt-get update
          sudo apt-get install -y fossil
      
      - name: Clone Fossil repository
        run: |
          fossil clone https://fossil.konoha.rest/ctodo ctodo.fossil
          
          # 作業ディレクトリを作成
          mkdir fossil-checkout
          cd fossil-checkout
          fossil open ../ctodo.fossil
          
          # 特定のブランチをチェックアウト（必要な場合）
          # fossil update trunk
          # fossil update branch-name
      
      - name: Export Fossil to Git
        run: |
          cd fossil-checkout
          
          # Fossilの全ファイルをルートにコピー（fossil-checkoutディレクトリを除外）
          rsync -av --exclude='.fslckout' --exclude='.fossil-settings' ./ ../temp-export/
          
          # ルートディレクトリに戻る
          cd ..
          
          # 既存のファイルを削除（.gitと.githubは保持）
          find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.git' ! -name '.github' ! -name 'fossil-checkout' ! -name 'ctodo.fossil' ! -name 'temp-export' -exec rm -rf {} +
          
          # エクスポートしたファイルを移動
          rsync -av temp-export/ ./
          
          # 一時ディレクトリを削除
          rm -rf temp-export fossil-checkout ctodo.fossil
      
      - name: Configure Git
        run: |
          git config user.name "Fossil Mirror Bot"
          git config user.email "bot@github-actions"
      
      - name: Commit and Push to GitHub
        run: |
          # 変更があるか確認
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Mirror from Fossil ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push
          else
            echo "No changes to commit"
          fi
